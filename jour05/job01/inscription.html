<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inscription</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h2>Inscription</h2>
      <form id="inscriptionForm" autocomplete="off" novalidate>
        <div class="form-group">
          <label for="nom">Nom</label>
          <input type="text" id="nom" name="nom" required />
          <div class="error" id="error-nom"></div>
        </div>
        <div class="form-group">
          <label for="prenom">Prénom</label>
          <input type="text" id="prenom" name="prenom" required />
          <div class="error" id="error-prenom"></div>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required />
          <div class="error" id="error-email"></div>
        </div>
        <div class="form-group password-group">
          <label for="password">Mot de passe</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            minlength="8"
            class="password-input"
          />
          <button
            type="button"
            id="togglePassword"
            aria-label="Afficher/masquer le mot de passe"
            class="toggle-password-btn"
          >
            <span id="eyeIcon">
              <!-- Icône SVG œil par défaut -->
              <svg id="svgEye" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="12" rx="9" ry="5"/><circle cx="12" cy="12" r="2.5"/></svg>
            </span>
          </button>
          <div class="error" id="error-password"></div>
        </div>
        <div class="form-group">
          <label for="adresse">Adresse</label>
          <input type="text" id="adresse" name="adresse" required />
          <div class="error" id="error-adresse"></div>
        </div>
        <div class="form-group">
          <label for="ville">Ville</label>
          <input
            type="text"
            id="ville"
            name="ville"
            placeholder="Commencez à taper une ville..."
            autocomplete="off"
            required
          />
          <div
            id="ville-autocomplete"
            class="autocomplete-items"
            style="position: relative"
          ></div>
          <div class="error" id="error-ville"></div>
        </div>
        <div class="form-group">
          <label for="codepostal">Code postal</label>
          <input type="text" id="codepostal" name="codepostal" required />
          <div class="error" id="error-codepostal"></div>
        </div>
        <button type="submit" id="submitBtn" class="submit-btn" disabled>
          Inscription
        </button>
      </form>
      <button onclick="window.location.href='index.php'" class="retour-btn">
        Retour à l'accueil
      </button>
    </div>
    <script>
      // Validation rules
      let villesSuggestions = [];
      let villesData = {};
      const villeInput = document.getElementById("ville");
      const autocompleteDiv = document.getElementById("ville-autocomplete");

      villeInput.addEventListener("input", async function () {
        const query = villeInput.value.trim();
        autocompleteDiv.innerHTML = "";
        villesSuggestions = [];
        villesData = {};
        if (query.length < 2) {
          return;
        }
        try {
          const response = await fetch(
            "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&accept-language=fr&q=" +
              encodeURIComponent(query)
          );
          const villes = await response.json();
          if (villes.length === 0) {
            const item = document.createElement("div");
            item.className = "autocomplete-item";
            item.textContent = "Aucune ville trouvée";
            item.style.background = "#f7f7f7";
            autocompleteDiv.appendChild(item);
          } else {
            villes.forEach((v) => {
              // On prend le nom de la ville (display_name ou address.city/town/village)
              let cityName = v.display_name;
              if (v.address) {
                cityName =
                  v.address.city ||
                  v.address.town ||
                  v.address.village ||
                  v.address.hamlet ||
                  v.display_name;
              }
              villesData[cityName] = {
                code: v.address && v.address.postcode ? v.address.postcode : "",
              };
              villesSuggestions.push(cityName);
              const item = document.createElement("div");
              item.className = "autocomplete-item";
              item.textContent = cityName;
              item.style.cursor = "pointer";
              item.style.background = "#fff";
              item.style.border = "1px solid #ccc";
              item.style.padding = "6px";
              item.addEventListener("mousedown", function () {
                villeInput.value = cityName;
                autocompleteDiv.innerHTML = "";
                villeInput.dispatchEvent(new Event("change"));
              });
              autocompleteDiv.appendChild(item);
            });
          }
        } catch (e) {
          const item = document.createElement("div");
          item.className = "autocomplete-item";
          item.textContent = "Erreur lors de la recherche";
          item.style.background = "#f7f7f7";
          autocompleteDiv.appendChild(item);
        }
      });

      // Fermer la liste si on clique ailleurs
      document.addEventListener("click", function (e) {
        if (e.target !== villeInput) {
          autocompleteDiv.innerHTML = "";
        }
      });

      const form = document.getElementById("inscriptionForm");
      const submitBtn = document.getElementById("submitBtn");
      const fields = [
        "nom",
        "prenom",
        "email",
        "password",
        "adresse",
        "ville",
        "codepostal",
      ];

      // Asynchronous validation simulation
      function asyncValidate(field, value) {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve(validators[field](value));
          }, 200); // Simule une requête asynchrone
        });
      }

      async function validateField(field) {
        const input = document.getElementById(field);
        const errorDiv = document.getElementById("error-" + field);
        const errorMsg = await asyncValidate(field, input.value);
        errorDiv.textContent = errorMsg;
        return !errorMsg;
      }

      async function validateForm() {
        let valid = true;
        for (const field of fields) {
          const isValid = await validateField(field);
          if (!isValid) valid = false;
        }
        submitBtn.disabled = !valid;
        return valid;
      }

      // Validate on input
      fields.forEach((field) => {
        document.getElementById(field).addEventListener("input", () => {
          validateField(field);
          validateForm();
        });
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const isValid = await validateForm();
        if (isValid) {
          alert("Inscription réussie !");
          form.reset();
          fields.forEach(
            (f) => (document.getElementById("error-" + f).textContent = "")
          );
          submitBtn.disabled = true;
        }
      });

      // Validation rules
      const validators = {
        nom: (value) => {
          const regex = /^[a-zA-ZÀ-ÿ\s-]{2,50}$/;
          if (!regex.test(value.trim())) {
            return "Le nom doit contenir 2 à 50 lettres, espaces ou tirets.";
          }
          return "";
        },
        prenom: (value) => {
          const regex = /^[a-zA-ZÀ-ÿ\s-]{2,50}$/;
          if (!regex.test(value.trim())) {
            return "Le prénom doit contenir 2 à 50 lettres, espaces ou tirets.";
          }
          return "";
        },
        email: (value) =>
          /^[\w-.]+@([\w-]+\.)+[\w-]{2,}$/.test(value)
            ? ""
            : "L'email n'est pas valide.",
        password: (value) => {
          // Bonnes pratiques :
          // - Au moins 8 caractères
          // - Au moins une minuscule
          // - Au moins une majuscule
          // - Au moins un chiffre
          // - Au moins un caractère spécial
          // - Pas d'espaces
          if (value.length < 8)
            return "Le mot de passe doit contenir au moins 8 caractères.";
          if (!/[a-z]/.test(value))
            return "Le mot de passe doit contenir au moins une minuscule.";
          if (!/[A-Z]/.test(value))
            return "Le mot de passe doit contenir au moins une majuscule.";
          if (!/[0-9]/.test(value))
            return "Le mot de passe doit contenir au moins un chiffre.";
          if (!/[@$!%*?&]/.test(value))
            return "Le mot de passe doit contenir au moins un caractère spécial (@$!%*?&).";
          if (/\s/.test(value))
            return "Le mot de passe ne doit pas contenir d'espace.";
          return "";
        },
        // Adresse : au moins 4 caractères (international)
        adresse: (value) => {
          const val = value.trim();
          if (val.length < 4)
            return "L'adresse doit contenir au moins 4 caractères.";
          return "";
        },
        ville: (value) => {
          if (!value) return "La ville est requise.";
          if (!villesSuggestions.includes(value))
            return "Sélectionnez une ville dans la liste.";
          return "";
        },
        codepostal: (value) => {
          if (!/^[\\w\\s-]{3,10}$/.test(value))
            return "Le code postal doit être valide.";
          // Vérifie la cohérence avec la ville
          const ville = document.getElementById("ville").value.trim();
          if (ville && villesData[ville] && villesData[ville].code !== value) {
            return "Le code postal ne correspond pas à la ville.";
          }
          return "";
        },
      };
      // Afficher/masquer le mot de passe
      const passwordInput = document.getElementById("password");
      const togglePasswordBtn = document.getElementById("togglePassword");
      const eyeIcon = document.getElementById("eyeIcon");
      let passwordVisible = false;
      togglePasswordBtn.addEventListener("click", function () {
        passwordVisible = !passwordVisible;
        passwordInput.type = passwordVisible ? "text" : "password";
        // Change SVG selon l'état
        if (passwordVisible) {
          eyeIcon.innerHTML = `<svg id="svgEyeOff" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="12" rx="9" ry="5"/><circle cx="12" cy="12" r="2.5"/><line x1="3" y1="21" x2="21" y2="3"/></svg>`;
        } else {
          eyeIcon.innerHTML = `<svg id="svgEye" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="12" rx="9" ry="5"/><circle cx="12" cy="12" r="2.5"/></svg>`;
        }
      });
    </script>
  </body>
</html>
